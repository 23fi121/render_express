<body>
  <!-- 名前入力画面 -->
  <div id="name-setup">
    <h2>ユーザーネームを入力してください</h2>
    <input type="text" id="name-input" placeholder="例: Taro" />
    <button id="start-button">開始</button>
  </div>

  <!-- チャットとキャンバス（初期では非表示） -->
  <div id="main" style="display: none;">
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>
    <canvas
      id="canvas"
      width="600"
      height="600"
      style="border: solid 1px black"
    ></canvas>
  </div>

  <script>
    let myName = ''

    document.getElementById('start-button').addEventListener('click', () => {
      const nameInput = document.getElementById('name-input')
      const name = nameInput.value.trim()
      if (!name) {
        alert('名前を入力してください')
        return
      }

      myName = name
      document.getElementById('name-setup').style.display = 'none'
      document.getElementById('main').style.display = 'block'
      main()
    })

    function main() {
      const host = location.origin.replace(/^http/, 'ws')
      const ws = new WebSocket(host + '/ws')

      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')

      let drawing = false

      canvas.addEventListener('mousedown', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown')
      })
      function mousedown(x, y) {
        drawing = true
        ctx.beginPath()
        ctx.moveTo(x, y)
      }

      canvas.addEventListener('mousemove', (e) => {
        if (drawing) {
          sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove')
        }
      })
      function mousemove(x, y) {
        if (drawing) {
          draw(x, y, true)
        }
      }

      canvas.addEventListener('mouseup', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup')
      })
      function mouseup() {
        drawing = false
        ctx.beginPath()
      }

      canvas.addEventListener('mouseout', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout')
      })
      function mouseout() {
        drawing = false
      }

      function draw(x, y, dragging) {
        if (dragging) {
          ctx.lineTo(x, y)
          ctx.stroke()
        } else {
          ctx.moveTo(x, y)
        }
      }

      function sendDrawingEvent(x, y, control) {
        const message = JSON.stringify({ x, y, control, type: 'paint' })
        ws.send(message)
      }

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data)
        if (msg.type === 'paint') {
          const { x, y, control } = msg
          if (control === 'mousedown') {
            mousedown(x, y)
          } else if (control === 'mouseup') {
            mouseup()
          } else if (control === 'mousemove') {
            mousemove(x, y)
          } else if (control === 'mouseout') {
            mouseout()
          }
        }

        if (msg.type === 'chat') {
          const { id, text } = msg
          const messageList = document.querySelector('.messages')
          const li = document.createElement('li')
          if (id === myName) {
            li.textContent = `(${id})自分:` + text
          } else {
            li.textContent = id + ': ' + text
          }
          messageList.appendChild(li)
        }
      }

      const form = document.querySelector('.form')

      form.onsubmit = function (e) {
        e.preventDefault()
        const input = document.querySelector('.input')
        const text = input.value
        ws.send(JSON.stringify({ id: myName, text, type: 'chat' }))
        input.value = ''
        input.focus()
      }

      ws.onerror = function (error) {
        console.error('WebSocket Error: ', error)
      }
    }
  </script>
</body>
